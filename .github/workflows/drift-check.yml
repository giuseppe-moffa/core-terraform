name: Drift Check

on:
  schedule:
    - cron: "0 2 * * *" # 2 AM daily
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  actions: write

jobs:
  enumerate-and-check:
    runs-on: ubuntu-latest
    env:
      TFPILOT_API_URL: ${{ secrets.TFPILOT_API_URL || 'https://tfpilot.com' }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Fetch Eligible Requests
        id: fetch
        run: |
          set -euxo pipefail
          RESPONSE=$(curl -s "${TFPILOT_API_URL}/api/requests/drift-eligible" || echo '{"success":false,"requests":[]}')
          echo "eligible_requests<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Filter Core Project Requests
        id: filter
        run: |
          set -euxo pipefail
          ELIGIBLE=$(echo '${{ steps.fetch.outputs.eligible_requests }}' | jq -r '.requests[] | select(.project == "core") | .id' || echo "")
          echo "request_ids<<EOF" >> $GITHUB_OUTPUT
          echo "$ELIGIBLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Dispatch Drift-Plan for Each Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          REQUEST_IDS=$(echo '${{ steps.filter.outputs.request_ids }}' | tr '\n' ' ')
          
          if [ -z "$REQUEST_IDS" ]; then
            echo "No eligible requests found for core project"
            exit 0
          fi
          
          for REQUEST_ID in $REQUEST_IDS; do
            if [ -z "$REQUEST_ID" ]; then
              continue
            fi
            
            echo "Dispatching drift-plan for request: $REQUEST_ID"
            
            # Get request details to determine environment
            REQUEST_DETAILS=$(curl -s "${TFPILOT_API_URL}/api/requests/${REQUEST_ID}" || echo '{}')
            ENV=$(echo "$REQUEST_DETAILS" | jq -r '.request.environment // "dev"' || echo "dev")
            
            # Dispatch drift-plan workflow
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/drift-plan.yml/dispatches" \
              -d "{
                \"ref\": \"main\",
                \"inputs\": {
                  \"request_id\": \"${REQUEST_ID}\",
                  \"environment\": \"${ENV}\"
                }
              }" || echo "Failed to dispatch for ${REQUEST_ID} (non-fatal)"
            
            # Small delay to avoid rate limits
            sleep 1
          done
