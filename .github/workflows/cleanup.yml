name: cleanup

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "TfPilot request ID"
        required: true
      environment:
        description: "Target environment"
        required: true
      target_base:
        description: "Base branch"
        required: false
        default: "main"
      cleanup_paths:
        description: "Comma-separated paths to remove"
        required: false
        default: ""
      target_env_path:
        description: "Environment path (informational)"
        required: false
        default: ""
      auto_merge:
        description: "Auto-merge when not prod"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: cleanup-${{ inputs.request_id }}
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_base }}

      - name: Configure git
        run: |
          git config user.name "tfpilot-bot"
          git config user.email "tfpilot-bot@users.noreply.github.com"

      - name: Normalize cleanup paths
        id: paths
        run: |
          echo "${{ inputs.cleanup_paths }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' > paths.txt
          count=$(wc -l < paths.txt || true)
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Remove files
        if: steps.paths.outputs.count != '0'
        run: |
          while IFS= read -r p; do
            if [ -e "$p" ]; then
              git rm -r "$p"
              echo "Removed $p"
            else
              echo "Path not found, skipping: $p"
            fi
          done < paths.txt

      - name: Create branch and commit
        id: commit
        run: |
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          BR="cleanup/${{ inputs.request_id }}"
          git fetch origin "$BR" || true
          git checkout -B "$BR" "${{ inputs.target_base }}"
          git commit -m "Cleanup request ${{ inputs.request_id }}"
          git push --force origin "$BR"
          echo "branch=$BR" >> $GITHUB_OUTPUT

      - name: Create PR
        id: pr
        if: steps.commit.outputs.no_changes != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BR="${{ steps.commit.outputs.branch }}"
          pr_info=$(gh pr create \
            --base "${{ inputs.target_base }}" \
            --head "$BR" \
            --title "Cleanup request ${{ inputs.request_id }}" \
            --body "Automated cleanup for request ${{ inputs.request_id }} in environment '${{ inputs.environment }}'.")
          pr_url=$(gh pr view "$BR" --json url --jq .url)
          pr_number=$(gh pr view "$BR" --json number --jq .number)
          echo "url=$pr_url" >> $GITHUB_OUTPUT
          echo "number=$pr_number" >> $GITHUB_OUTPUT
          echo "$pr_info"

      - name: Enable auto-merge (non-prod)
        if: inputs.auto_merge == 'true' && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "${{ steps.pr.outputs.number }}" --merge --auto
